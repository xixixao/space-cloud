// Generated by CoffeeScript 1.6.2
(function() {
  var Q, connect, defineModels, models, mongoose, populate, printStats, wipe;

  Q = require('q');

  (require('./q-each'))(Q);

  mongoose = require('mongoose');

  (require('./mongoose-promise-save'))(mongoose);

  defineModels = function() {
    var Course, Schema, User, courseSchema, userSchema;

    Schema = mongoose.Schema;
    courseSchema = Schema({
      name: String,
      courseCode: Number
    });
    Course = mongoose.model('Course', courseSchema);
    userSchema = Schema({
      name: String,
      courses: [
        {
          type: Schema.Types.ObjectId,
          ref: 'Course'
        }
      ]
    });
    User = mongoose.model('User', userSchema);
    return {
      Course: Course,
      User: User
    };
  };

  module.exports = models = defineModels();

  connect = function() {
    var db;

    mongoose.connect("mongodb://localhost/test");
    db = mongoose.connection;
    return db.on("error", function(error) {
      return console.error("There has been an error:\n", error);
    });
  };

  wipe = function() {
    var db;

    db = mongoose.connection;
    return Q.map(db.collections, function(collection) {
      return Q.invoke(collection, 'drop');
    });
  };

  populate = function(_arg) {
    var Course, User, courses, users;

    Course = _arg.Course, User = _arg.User;
    courses = Q.map([0, 1, 2, 3], function(i) {
      var course;

      course = new Course({
        name: "course " + i,
        courseCode: i
      });
      return course.save();
    });
    users = Q.map([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], function(i) {
      var user;

      user = new User({
        name: "user" + i
      });
      courses.thenEach(function(course) {
        return user.courses.addToSet(course._id);
      });
      return user.save();
    });
    return Q.all([courses, users]);
  };

  printStats = function(_arg) {
    var Course, User, courses, users;

    User = _arg.User, Course = _arg.Course;
    users = User.find().exec().then(function(users) {
      return console.log("  Number of users " + users.length);
    });
    courses = Course.find().exec().then(function(courses) {
      return console.log("  Number of courses " + courses.length);
    });
    return Q.all([users, courses]);
  };

  connect();

  wipe().then(function() {
    console.log("After wiping out");
    return printStats(models);
  }).then(function() {
    return populate(models);
  }).then(function() {
    console.log("After populating");
    return printStats(models);
  }).done();

}).call(this);
