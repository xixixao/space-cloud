// Generated by CoffeeScript 1.6.2
(function() {
  var Q, connect, defineModels, models, mongoose, populate, printStats, wipe;

  Q = require('q');

  (require('./q-each'))(Q);

  mongoose = require('mongoose');

  (require('./mongoose-promise-save'))(mongoose);

  defineModels = function() {
    var Answer, CommentA, CommentQ, Event, File, Question, Schema, Topic, User, answerSchema, commentASchema, commentQSchema, eventSchema, fileSchema, questionSchema, topicPermission, topicSchema, userSchema;

    Schema = mongoose.Schema;
    topicSchema = Schema({
      name: String,
      _id: {
        type: String,
        unique: true,
        dropDups: true
      }
    });
    Topic = mongoose.model('Topic', topicSchema);
    topicPermission = Schema({
      code: {
        type: String,
        ref: 'Topic'
      },
      permission: String
    });
    userSchema = Schema({
      name: String,
      _id: {
        type: String,
        unique: true,
        dropDups: true
      },
      password: String,
      topics: [topicPermission]
    });
    User = mongoose.model('User', userSchema);
    fileSchema = Schema({
      _id: {
        type: String,
        unique: true
      },
      path: String,
      name: String,
      owner: {
        type: String,
        ref: 'User'
      },
      topicCode: {
        type: String,
        ref: 'Topic'
      }
    });
    File = mongoose.model('File', fileSchema);
    questionSchema = Schema({
      _id: {
        type: String,
        unique: true
      },
      createdTime: {
        type: Date,
        "default": Date.now
      },
      modifiedQuestionTime: {
        type: Date,
        "default": Date.now
      },
      modifiedTime: {
        type: Date,
        "default": Date.now
      },
      owner: {
        type: String,
        ref: 'User'
      },
      filePosition: String,
      file: {
        type: String,
        ref: 'File'
      },
      answers: [answerSchema],
      comments: [commentQSchema],
      text: String
    });
    Question = mongoose.model('Question', questionSchema);
    answerSchema = Schema({
      _id: {
        type: String,
        unique: true,
        dropDups: true
      },
      timestamp: {
        type: Date,
        "default": Date.now
      },
      owner: {
        type: String,
        ref: 'User'
      },
      question: {
        type: String,
        ref: 'Question'
      },
      rank: Number,
      comments: [commentASchema],
      text: String
    });
    Answer = mongoose.model('Answer', answerSchema);
    commentQSchema = Schema({
      _id: {
        type: String,
        unique: true,
        dropDups: true
      },
      timestamp: {
        type: Date,
        "default": Date.now
      },
      owner: {
        type: String,
        ref: 'User'
      },
      question: {
        type: String,
        ref: 'Question'
      },
      text: String
    });
    CommentQ = mongoose.model('CommentQ', commentQSchema);
    commentASchema = Schema({
      _id: {
        type: String,
        unique: true,
        dropDups: true
      },
      timestamp: {
        type: Date,
        "default": Date.now
      },
      owner: {
        type: String,
        ref: 'User'
      },
      answer: {
        type: String,
        ref: 'Answer'
      },
      text: String
    });
    CommentA = mongoose.model('CommentA', commentASchema);
    eventSchema = Schema({
      type: String,
      timestamp: {
        type: Date,
        "default": Date.now
      }
    });
    Event = mongoose.model('Event', eventSchema);
    return {
      Topic: Topic,
      User: User,
      File: File,
      Question: Question,
      CommentA: CommentA,
      CommentQ: CommentQ,
      Answer: Answer,
      Event: Event
    };
  };

  module.exports = models = defineModels();

  connect = function() {
    var db;

    mongoose.connect("mongodb://localhost/test");
    db = mongoose.connection;
    return db.on("error", function(error) {
      return console.error("There has been an error:\n", error);
    });
  };

  wipe = function() {
    var db;

    db = mongoose.connection;
    return Q.map(db.collections, function(collection) {
      return Q.ninvoke(collection, 'drop');
    });
  };

  module.exports.wipe = wipe;

  populate = function(_arg) {
    var Topic, User, topics, users;

    Topic = _arg.Topic, User = _arg.User;
    topics = Q.map([0, 1, 2, 3], function(i) {
      var topic;

      topic = new Topic({
        name: "topic " + i,
        _id: i
      });
      return topic.save();
    });
    users = Q.map([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], function(i) {
      var user;

      user = new User({
        name: "user" + i
      });
      topics.thenEach(function(topic) {
        return user.topics.addToSet(topic._id);
      });
      return user.save();
    });
    return Q.all([topics, users]);
  };

  printStats = function(_arg) {
    var Topic, User, topics, users;

    User = _arg.User, Topic = _arg.Topic;
    users = User.find().exec().then(function(users) {
      return console.log("  Number of users " + users.length);
    });
    topics = Topic.find().exec().then(function(topics) {
      return console.log("  Number of topics " + topics.length);
    });
    return Q.all([users, topics]);
  };

  connect();

  wipe();

}).call(this);
