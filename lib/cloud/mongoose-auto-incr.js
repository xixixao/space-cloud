// Generated by CoffeeScript 1.6.2
(function() {
  var counter_name, db, mongoose;

  mongoose = require('mongoose');

  counter_name = null;

  db = null;

  exports.loadAutoIncr = function(database, options) {
    var schema;

    options = options || {};
    counter_name = options.counterName || '__Counter__';
    db = database;
    schema = new mongoose.Schema({
      field: {
        type: String,
        unique: true
      },
      c: {
        type: Number,
        "default": 0
      }
    });
    return mongoose.model(counter_name, schema);
  };

  exports.model = function(modelName, schema) {
    var Counter, model_name;

    if (!modelName) {
      throw new Error('Missing required parameter: modelName');
    }
    model_name = modelName.toLowerCase();
    Counter = db.model(counter_name);
    schema.add({
      _id: Number
    });
    schema.pre('save', function(next) {
      var _this = this;

      return Counter.collection.findAndModify({
        field: model_name
      }, [], {
        $inc: {
          c: 1
        }
      }, {
        "new": true,
        upsert: true
      }, function(err, doc) {
        var count;

        count = doc.c;
        if (err) {
          return next(err);
        } else {
          _this._id = count;
          return next();
        }
      });
    });
    return mongoose.model(modelName, schema);
  };

}).call(this);
