// Generated by CoffeeScript 1.6.2
(function() {
  var Answer, CommentA, CommentQ, Event, File, Q, Question, Topic, User, authenticated, canRead, canWrite, passport, _ref, _ref1;

  Q = require('q');

  (require('./q-each'))(Q);

  passport = require("passport");

  _ref = require('./model'), Topic = _ref.Topic, User = _ref.User, File = _ref.File, CommentA = _ref.CommentA, CommentQ = _ref.CommentQ, Question = _ref.Question, Answer = _ref.Answer, Event = _ref.Event;

  _ref1 = require('./authentication'), canRead = _ref1.canRead, canWrite = _ref1.canWrite, authenticated = _ref1.authenticated;

  module.exports = function(app) {
    var addEvent, findAnswer, findCommentA, findCommentQ, findFile, findQuestion, findTopic, usersFiles;

    app.get('/users/:login', function(request, response) {
      return usersFiles(request.params.login).then(function(user) {
        return response.send(user);
      }, function(error) {
        return response.send(error);
      });
    });
    usersFiles = function(userId) {
      return Q.ninvoke(User, 'findById', userId).then(function(user) {
        return Q.ninvoke(user, 'populate', 'topics.code');
      }).then(function(user) {
        var fileLists, topicPermissions;

        user = user.toObject();
        topicPermissions = user.topics;
        fileLists = Q.map(topicPermissions, function(_arg) {
          var code, topicId;

          code = _arg.code;
          topicId = code._id;
          return Q.ninvoke(File, 'find', {
            topicCode: topicId
          });
        });
        return fileLists.thenEach(function(files, i) {
          return user.topics[i].code.files = files;
        }).then(function() {
          return user;
        });
      });
    };
    app.post('/users', function(request, response) {
      var user;

      user = new User({
        name: request.body.name,
        _id: request.body._id,
        password: request.body.password,
        topics: request.body.topics
      });
      return user.save(function(err) {
        if (err != null) {
          return response.send(err);
        } else {
          return response.send(user);
        }
      });
    });
    app.post('/login', passport.authenticate('local'), function(request, response) {
      return response.send("logged in");
    });
    app.post('/topics', function(request, response) {
      var topic;

      topic = new Topic({
        name: request.body.name,
        _id: request.body._id,
        files: []
      });
      return topic.save(function(err) {
        if (err != null) {
          return response.send(err);
        } else {
          return response.send(topic);
        }
      });
    });
    app.get('/topics/:code', function(request, response) {
      var topicCode;

      topicCode = request.params.code;
      return Topic.findById(topicCode, function(err, docs) {
        if (err != null) {
          return response.send("not found");
        } else {
          return response.send(docs);
        }
      });
    });
    app.post('/users/:login', function(request, response) {
      return User.findById(request.params.login, function(err, user) {
        var topic, topics, _i, _len;

        if (err != null) {
          return response.send(err);
        } else {
          topics = request.body.topics;
          for (_i = 0, _len = topics.length; _i < _len; _i++) {
            topic = topics[_i];
            user.topics.addToSet(topic);
          }
          return response.send(user);
        }
      });
    });
    addEvent = function(type, model, link) {
      var event;

      event = new Event({
        model: model,
        type: type,
        link: link
      });
      return event.save(function(err) {
        if (err != null) {
          return err;
        } else {
          return event;
        }
      });
    };
    app.get('/events', function(request, response) {
      return Event.find({}).sort('-timestamp').exec(function(err, events) {
        if (err != null) {
          return response.send(err);
        } else {
          return Q.map(events, function(event) {
            return Q.ninvoke(event, 'populate', {
              model: event.model,
              path: 'link'
            });
          }).then(function(events) {
            return response.send(events);
          });
        }
      });
    });
    findTopic = function(_arg) {
      var topicId;

      topicId = _arg.topicId;
      return Q.ninvoke(Topic, 'findById', topicId).then(function(topic) {
        if (topic == null) {
          throw [404, "topic not found"];
        }
        return topic;
      });
    };
    app.post('/topics/:topicId/files', authenticated, function(request, response) {
      var file;

      if (!canWrite(request, request.params.topicId)) {
        return response.send(401, 'User doesnt have write permission');
      }
      file = new File({
        _id: request.body._id,
        path: request.body.path,
        name: request.body.name,
        owner: request.body.owner
      });
      return findTopic(request.params).then(function(topic) {
        topic.files.addToSet(file);
        addEvent("Added", "File", file._id);
        return topic.save();
      }).then(function() {
        return response.send(file);
      }, function(error) {
        return response.send(500, error);
      }).done();
    });
    findFile = function(request, _arg) {
      var fileId, topicId;

      topicId = _arg.topicId, fileId = _arg.fileId;
      return findTopic({
        topicId: topicId
      }).then(function(topic) {
        if (!canRead(request, topicId)) {
          throw [401, "cant read"];
        }
        return [topic, topic.files.id(fileId)];
      });
    };
    app.get('/topics/:topicId/files/:fileId', authenticated, function(request, response) {
      return findFile(request, request.params).then(function(_arg) {
        var file, topic;

        topic = _arg[0], file = _arg[1];
        return response.send(file);
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    app.post('/topics/:topicId/files/:fileId/questions', authenticated, function(request, response) {
      return findFile(request, request.params).then(function(_arg) {
        var file, question, topic;

        topic = _arg[0], file = _arg[1];
        question = new Question({
          _id: request.body._id,
          owner: request.body.owner,
          filePosition: request.body.filePosition,
          file: request.body.file,
          text: request.body.text
        });
        file.questions.addToSet(question);
        return Q.ninvoke(topic, 'save').then(function() {
          addEvent("Added", "Question", question._id);
          return response.send(question);
        });
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    findQuestion = function(request, _arg) {
      var fileId, questionId, topicId;

      topicId = _arg.topicId, fileId = _arg.fileId, questionId = _arg.questionId;
      return findFile(request, {
        topicId: topicId,
        fileId: fileId
      }).then(function(_arg1) {
        var file, question, topic;

        topic = _arg1[0], file = _arg1[1];
        question = file.questions.id(questionId);
        return [topic, file, question];
      });
    };
    app.get('/topics/:topicId/files/:fileId/questions/:questionId', authenticated, function(request, response) {
      return findQuestion(request, request.params).then(function(_arg) {
        var file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2];
        return response.send(question);
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    app.post('/topics/:topicId/files/:fileId/questions/:questionId/answers', authenticated, function(request, response) {
      return findQuestion(request, request.params).then(function(_arg) {
        var answer, file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2];
        answer = new Answer({
          _id: request.body._id,
          owner: request.body.owner,
          question: request.body.question,
          rank: request.body.rank,
          text: request.body.text
        });
        question.answers.addToSet(answer);
        return Q.ninvoke(topic, 'save').then(function() {
          addEvent("Added", "Answer", answer._id);
          return response.send(question);
        });
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    findAnswer = function(request, _arg) {
      var answerId, fileId, questionId, topicId;

      topicId = _arg.topicId, fileId = _arg.fileId, questionId = _arg.questionId, answerId = _arg.answerId;
      return findQuestion(request, {
        topicId: topicId,
        fileId: fileId,
        questionId: questionId
      }).then(function(_arg1) {
        var answer, file, question, topic;

        topic = _arg1[0], file = _arg1[1], question = _arg1[2];
        answer = question.answers.id(answerId);
        return [topic, file, question, answer];
      });
    };
    app.get('/topics/:topicId/files/:fileId/questions/:questionId/answers/:answerId', authenticated, function(request, response) {
      return findAnswer(request, request.params).then(function(_arg) {
        var answer, file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2], answer = _arg[3];
        return response.send(answer);
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    app.post('/topics/:topicId/files/:fileId/questions/:questionId/comments', authenticated, function(request, response) {
      return findQuestion(request, request.params).then(function(_arg) {
        var comment, file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2];
        comment = new CommentQ({
          _id: request.body._id,
          owner: request.body.owner,
          question: request.body.question,
          text: request.body.text
        });
        question.comments.addToSet(comment);
        return Q.ninvoke(topic, 'save').then(function() {
          addEvent("Added", "CommentQ", comment._id);
          return response.send(comment);
        });
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    findCommentQ = function(request, _arg) {
      var commentId, fileId, questionId, topicId;

      topicId = _arg.topicId, fileId = _arg.fileId, questionId = _arg.questionId, commentId = _arg.commentId;
      return findQuestion(request, {
        topicId: topicId,
        fileId: fileId,
        questionId: questionId
      }).then(function(_arg1) {
        var comment, file, question, topic;

        topic = _arg1[0], file = _arg1[1], question = _arg1[2];
        comment = question.comments.id(commentId);
        return [topic, file, question, comment];
      });
    };
    app.get('/topics/:topicId/files/:fileId/questions/:questionId/comments/:commentId', authenticated, function(request, response) {
      return findCommentQ(request, request.params).then(function(_arg) {
        var comment, file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2], comment = _arg[3];
        return response.send(comment);
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    app.post('/topics/:topicId/files/:fileId/questions/:questionId/answers/:answerId/comments', authenticated, function(request, response) {
      return findAnswer(request, request.params).then(function(_arg) {
        var answer, comment, file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2], answer = _arg[3];
        comment = new CommentA({
          _id: request.body._id,
          owner: request.body.owner,
          answer: request.body.answer,
          text: request.body.text
        });
        answer.comments.addToSet(comment);
        return Q.ninvoke(topic, 'save').then(function() {
          addEvent("Added", "CommentA", comment._id);
          return response.send(comment);
        });
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    findCommentA = function(request, _arg) {
      var answerId, commentId, fileId, questionId, topicId;

      topicId = _arg.topicId, fileId = _arg.fileId, questionId = _arg.questionId, answerId = _arg.answerId, commentId = _arg.commentId;
      return findAnswer(request, {
        topicId: topicId,
        fileId: fileId,
        questionId: questionId,
        answerId: answerId
      }).then(function(_arg1) {
        var answer, comment, file, question, topic;

        topic = _arg1[0], file = _arg1[1], question = _arg1[2], answer = _arg1[3];
        comment = answer.comments.id(commentId);
        return [topic, file, question, answer, comment];
      });
    };
    app.get('/topics/:topicId/files/:fileId/questions/:questionId/answers/:answerId/comments/:commentId', authenticated, function(request, response) {
      return findCommentA(request, request.params).then(function(_arg) {
        var answer, comment, file, question, topic;

        topic = _arg[0], file = _arg[1], question = _arg[2], answer = _arg[3], comment = _arg[4];
        return response.send(comment);
      }, function(error) {
        return response.send.apply(response, error);
      }).done();
    });
    return app.get('/feeds/:user', authenticated, function(request, response) {
      return Q.ninvoke(User.findById(request.params.user).select('topics.code'), 'exec').then(function(_arg) {
        var code, topicCodes, topics;

        topics = _arg.topics;
        topicCodes = (function() {
          var _i, _len, _results;

          _results = [];
          for (_i = 0, _len = topics.length; _i < _len; _i++) {
            code = topics[_i].code;
            _results.push(code);
          }
          return _results;
        })();
        return Q.ninvoke(Question.find({}).populate({
          path: 'file',
          match: {
            topicCode: {
              $in: topicCodes
            }
          }
        }).sort('-modifiedTime'), 'exec').then(function(questions) {
          var q, _i, _len, _results;

          _results = [];
          for (_i = 0, _len = questions.length; _i < _len; _i++) {
            q = questions[_i];
            if (q.file != null) {
              _results.push(q);
            }
          }
          return _results;
        });
      }).then(function(questions) {
        return response.send(questions);
      }).done();
    });
  };

}).call(this);
